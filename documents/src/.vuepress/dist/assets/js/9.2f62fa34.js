(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{267:function(e,a,t){"use strict";t.r(a);var r=t(38),n=Object(r.a)({},function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"ci-cd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ci-cd","aria-hidden":"true"}},[e._v("#")]),e._v(" CI/CD")]),e._v(" "),t("head",[t("script",{attrs:{src:"https://unpkg.com/mermaid@8.0.0/dist/mermaid.min.js"}}),e._v(" "),t("script",[e._v("\nconst mermaiding = function() {\n    const elements = document.querySelectorAll(\"pre>code.language-mermaid\");\n    for (let i = 0; i < elements.length; i++) {\n        const e = elements[i];\n        const pre = e.parentElement;\n        const replace = function(graph) {\n            const elem = document.createElement('div');\n            elem.innerHTML = graph;\n            elem.className = 'mermaid';\n            elem.setAttribute('data-processed', 'true');\n            pre.parentElement.replaceChild(elem, pre);\n        }\n        mermaid.mermaidAPI.render('id' + i, e.textContent, replace);\n    }\n}\n<p>if (document.readyState == 'interactive' || document.readyState == 'complete') {\nmermaiding();\n}else{\ndocument.addEventListener(&quot;DOMContentLoaded&quot;, mermaiding);\n}\n")])]),t("p"),e._v(" "),t("h1",{attrs:{id:"全体図"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#全体図","aria-hidden":"true"}},[e._v("#")]),e._v(" 全体図")]),e._v(" "),t("p",[e._v("簡単そうなのでGoogleCloudBuild を使う．以下は全体図．")]),e._v(" "),t("div",{staticClass:"language-mermaid extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("graph LR\n  GIT[github] --\x3e GCB \n  subgraph GCP\n    GCB --\x3e |deploy| GKE\n    GCB --\x3e |trigger| PS[pub/sub]\n    PS --\x3e |push| CF[cloud function]\n  end\n  CF --\x3e |Webhook| SL[slack]\n")])])]),t("h2",{attrs:{id:"service"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#service","aria-hidden":"true"}},[e._v("#")]),e._v(" service")]),e._v(" "),t("p",[e._v("基本的にサービスのデプロイはbranch名とサービス名(ディレクトリ名)が1対1に対応している\nbranchにpushしたりmergeするとビルドが走る")]),e._v(" "),t("h2",{attrs:{id:"google-cloud-functions"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#google-cloud-functions","aria-hidden":"true"}},[e._v("#")]),e._v(" google cloud functions")]),e._v(" "),t("p",[e._v("function の名前のブランチにpushすると更新される")]),e._v(" "),t("h2",{attrs:{id:"helm3-alpha"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#helm3-alpha","aria-hidden":"true"}},[e._v("#")]),e._v(" Helm3-alpha")]),e._v(" "),t("p",[e._v("helm 以下のディレクトリにチャートが揃っており，\n互いに共通の変数がディレクトリ直下の"),t("code",[e._v("values.yaml")]),e._v("にしまわれている．\nチャートごとの変数はそれぞれのチャートのディレクトリ以下にしまわれている．")]),e._v(" "),t("p",[e._v("チャート名やリリース名はkubeのリソース名に含まれるので，"),t("code",[e._v("lowercase")]),e._v("で\n"),t("code",[e._v("-")]),e._v("か"),t("code",[e._v(".")]),e._v("を使うようにする．")]),e._v(" "),t("p",[e._v("values.yamlを暗号化して復号化する際の権限の付与が "),t("code",[e._v("terraform")]),e._v(" でよくわからんかったので手動で付与")]),e._v(" "),t("p",[t("code",[e._v("helm upgrade")]),e._v(" でvalueが変わらなかったので，"),t("code",[e._v("helm template")]),e._v(" で生成してから "),t("code",[e._v("k apply -f -")]),e._v(" でやる方向で行く．")]),e._v(" "),t("h3",{attrs:{id:"dev"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dev","aria-hidden":"true"}},[e._v("#")]),e._v(" dev")]),e._v(" "),t("h3",{attrs:{id:"prd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#prd","aria-hidden":"true"}},[e._v("#")]),e._v(" prd")]),e._v(" "),t("h3",{attrs:{id:"tips"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tips","aria-hidden":"true"}},[e._v("#")]),e._v(" Tips")]),e._v(" "),t("h4",{attrs:{id:"helm-upgrade-install"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#helm-upgrade-install","aria-hidden":"true"}},[e._v("#")]),e._v(" "),t("code",[e._v("helm upgrade --install")])]),e._v(" "),t("p",[t("code",[e._v("release")]),e._v(" が存在しなければ "),t("code",[e._v("install")]),e._v(" をしてくれるので "),t("code",[e._v("kubectl apply")]),e._v(" と同じと見た")]),e._v(" "),t("h4",{attrs:{id:"upgrade-set-hoge-hogehoge-ではなにもやらない場合がある"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#upgrade-set-hoge-hogehoge-ではなにもやらない場合がある","aria-hidden":"true"}},[e._v("#")]),e._v(" "),t("code",[e._v("upgrade --set hoge=hogehoge")]),e._v(" ではなにもやらない場合がある")]),e._v(" "),t("p",[t("strong",[e._v("バグだった")]),t("br"),e._v("\n今の所一回消す必要あり"),t("br"),e._v("\n面倒なので "),t("code",[e._v("helm tempalte | kubectl apply -f -")]),e._v(" 使う．")]),e._v(" "),t("blockquote",[t("p",[e._v("同じバージョンで "),t("code",[e._v("image tag")]),e._v(" を変えても "),t("code",[e._v("pod image tag")]),e._v(" は変わらなかった．\n"),t("code",[e._v("deployments.apps")]),e._v(" の "),t("code",[e._v("image tag")]),e._v(" も変わっていなかった．\n"),t("code",[e._v("deployments.apps")]),e._v(" は更新されない模様．\n"),t("code",[e._v("helm history [release name]")]),e._v(" には新しく追加されている．"),t("br"),e._v(" "),t("a",{attrs:{href:"https://medium.com/@kcatstack/understand-helm-upgrade-flags-reset-values-reuse-values-6e58ac8f127e",target:"_blank",rel:"noopener noreferrer"}},[e._v("詳しく書いてくれている"),t("OutboundLink")],1),e._v("\n同じバージョンで "),t("code",[e._v("--recreate-pod")]),e._v(" を指定しても "),t("code",[e._v("image tag")]),e._v(" は変わらなかった")])])])},[],!1,null,null,null);a.default=n.exports}}]);