steps:
- name: 'gcr.io/cloud-builders/docker'
  id: 'pull-latest-image'
  entrypoint: '/bin/bash'
  args:
  - '-c'
  - 'docker pull docker.io/${_DOCKER_USERNAME}/${PROJECT_ID}-server:latest || true'
  waitFor: ['-']

- name: 'gcr.io/cloud-builders/docker'
  id: 'build-image'
  args:
  - 'build'
  - '-t'
  - 'docker.io/${_DOCKER_USERNAME}/${PROJECT_ID}-server:${REVISION_ID}'
  - '-t'
  - 'docker.io/${_DOCKER_USERNAME}/${PROJECT_ID}-server:latest'
  - '--cache-from'
  - 'docker.io/${_DOCKER_USERNAME}/${PROJECT_ID}-server:latest'
  - 'server/app'
  waitFor: ['pull-latest-image']

- name: 'gcr.io/cloud-builders/docker'
  id: 'docker-login'
  args:
  - 'login'
  - '-u'
  - '${_DOCKER_USERNAME}'
  - '-p'
  - '${_DOCKER_PASSWORD}'
  waitFor: ['-']

- name: 'gcr.io/cloud-builders/docker'
  id: 'push-image-latest'
  args:
  - 'push'
  - 'docker.io/${_DOCKER_USERNAME}/${PROJECT_ID}-server:latest'
  waitFor: ['docker-login', 'build-image']

- name: 'gcr.io/cloud-builders/docker'
  id: 'push-image-revision-id'
  args:
  - 'push'
  - 'docker.io/${_DOCKER_USERNAME}/${PROJECT_ID}-server:${REVISION_ID}'
  waitFor: ['docker-login', 'build-image']

# deploy

- name: 'gcr.io/cloud-builders/gcloud'
  id: 'get-cluster-credential'
  args:
    - 'container'
    - 'clusters'
    - 'get-credentials'
    - 'cluster'
    - '--zone=${_ZONE}'
    - '--project=${PROJECT_ID}'
  waitFor: ['-']


- name: 'gcr.io/cloud-builders/kubectl'
  id: 'sed-file'
  entrypoint: '/bin/bash'
  args:
  - '-c'
  - 'gcb/sed.sh ${PROJECT_ID} ${_DOCKER_USERNAME} ${REVISION_ID}'
  waitFor: ['push-image-revision-id']

- name: 'gcr.io/cloud-builders/kubectl'
  id: 'docker-credential'
  args:
  - 'create'
  - 'secret' 
  - '--save-config'
  - 'docker-registry'
  - 'docker-auth'
  - '--docker-server=docker.io'
  - '--docker-username=${_DOCKER_USERNAME}' 
  - '--docker-password=${_DOCKER_PASSWORD}' 
  - '--docker-email=${_DOCKER_EMAIL}'
  waitFor: ['-']

- name: 'gcr.io/cloud-builders/kubectl'
  id: 'deploy'
  args:
    - 'apply'
    - '-f' 
    - 'gcb/kube'
  waitFor: ['sed-file', 'get-cluster-credential']

timeout: 1800s
